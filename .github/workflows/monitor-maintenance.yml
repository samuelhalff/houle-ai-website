name: Monitor Maintenance

on:
  schedule:
    - cron: '*/3 * * * *'

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Check website
        run: |
          # Check if build-and-deploy workflow is currently running
          RUNNING=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-and-deploy.yml/runs | jq -r '.workflow_runs[] | select(.status == "in_progress") | .id' | head -1)
          
          if [ -n "$RUNNING" ]; then
            echo "Deploy already running (ID: $RUNNING), skipping"
          else
            HTML=$(curl -s https://houle.ai)
            if echo "$HTML" | grep -q "/images/infomaniak.svg"; then
              echo "Maintenance detected and no deploy running, triggering redeploy"
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-and-deploy.yml/dispatches \
                -d '{"ref":"main"}'
            else
              echo "Website is up"
            fi
          fi
