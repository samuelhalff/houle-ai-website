name: Build and Deploy (SSH)

on:
  push:
    branches: [main]
    paths:
      - "app/**"
      - "src/**"
      - "public/**"
      - "tailwind.config.*"
      - "postcss.config.*"
      - "next.config.js"
      - "package.json"
      - "package-lock.json"
      - "scripts/**"
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Restore Next.js build cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('src/**', 'app/**') }}
          restore-keys: |
            next-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-

      - name: Validate article references (non-blocking)
        continue-on-error: true
        run: npm run validate:article-refs -- --no-fail

      - name: Build
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: npm run build

      - name: Prepare artifact
        run: bash scripts/prepare-artifact.sh

      - name: Archive artifact
        run: tar -czf next-standalone.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: next-standalone
          path: next-standalone.tar.gz
          compression-level: 0
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: next-standalone
          path: ./artifact

      - name: Prepare partial artifact
        run: cp artifact/next-standalone.tar.gz artifact/next-standalone.tar.gz.part

      - name: Upload release to server (rsync)
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          HOST="${{ secrets.DEPLOY_SSH_HOST }}"
          USER="${{ secrets.DEPLOY_SSH_USER }}"
          PASS="${{ secrets.DEPLOY_SSH_PASSWORD }}"
          PORT="${{ secrets.DEPLOY_SSH_PORT }}"; [ -z "$PORT" ] && PORT=22

          sshpass -p "$PASS" rsync -av \
            -e "ssh -o StrictHostKeyChecking=no -p $PORT" \
            artifact/next-standalone.tar.gz.part \
            "$USER@$HOST:sites/houle.ai/artifact/"

      - name: Extract, symlink and cleanup releases
        run: |
          sudo apt-get install -y sshpass
          HOST="${{ secrets.DEPLOY_SSH_HOST }}"
          USER="${{ secrets.DEPLOY_SSH_USER }}"
          PASS="${{ secrets.DEPLOY_SSH_PASSWORD }}"
          PORT="${{ secrets.DEPLOY_SSH_PORT }}"; [ -z "$PORT" ] && PORT=22

          echo "[deploy] Testing SSH connectivity to $HOST:$PORT as $USER"
          if sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p "$PORT" "$USER@$HOST" 'echo "SSH probe successful"' 2>/dev/null; then
            echo "[deploy] SSH probe successful"
          else
            echo "[deploy] SSH probe failed (this may be expected); proceeding with deployment"
          fi

          sshpass -p "$PASS" ssh -p "$PORT" -o StrictHostKeyChecking=no "$USER@$HOST" bash -lc '
            set -euo pipefail
            BASE_DIR="sites/houle.ai"
            RELEASES_DIR="$BASE_DIR/releases"
            CURRENT_LINK="$BASE_DIR/current"
            ARTIFACT="$BASE_DIR/artifact/next-standalone.tar.gz"
            PART="$BASE_DIR/artifact/next-standalone.tar.gz.part"
            TS=$(date +%Y%m%d%H%M%S)
            REL_DIR="$RELEASES_DIR/$TS"
            TMP="/tmp/houle-release-$TS"
            LOG="$BASE_DIR/deploy.extract.log"

            echo "[deploy] Starting deployment at $(date)" >> "$LOG"
            echo "[deploy] Release timestamp: $TS" >> "$LOG"
            echo "[deploy] Target directory: $REL_DIR" >> "$LOG"

            mkdir -p "$RELEASES_DIR" "$TMP"
            echo "[deploy] Created directories" >> "$LOG"

            [ -f "$PART" ] && mv "$PART" "$ARTIFACT" && echo "[deploy] Moved partial artifact to final location" >> "$LOG"
            cp "$ARTIFACT" "$TMP/artifact.tar.gz"
            echo "[deploy] Copied artifact to temp directory" >> "$LOG"

            echo "[deploy] Extracting artifact..." >> "$LOG"
            gzip -cd "$TMP/artifact.tar.gz" > "$TMP/.payload.tar"
            tar -xf "$TMP/.payload.tar" --no-same-owner --no-same-permissions -C "$TMP"
            rm -f "$TMP/.payload.tar"
            echo "[deploy] Artifact extracted successfully" >> "$LOG"

            for f in server.js .next/BUILD_ID .next/static; do
              [ -e "$TMP/$f" ] || { echo "[deploy] ERROR: Missing required file: $f" >> "$LOG"; exit 1; }
            done
            echo "[deploy] All required files present" >> "$LOG"

            mv "$TMP" "$REL_DIR" || { cp -r "$TMP"/* "$REL_DIR"/ && rm -rf "$TMP"; }
            echo "[deploy] Moved to releases directory: $REL_DIR" >> "$LOG"

            mkdir -p "$BASE_DIR/shared"
            if [ -f "$BASE_DIR/shared/.env" ]; then
              ln -sfn "$BASE_DIR/shared/.env" "$REL_DIR/.env"
              echo "[deploy] Linked .env file" >> "$LOG"
            fi

            ln -sfn "$REL_DIR" "$CURRENT_LINK"
            echo "$TS" > "$BASE_DIR/last_release_ts"
            echo "[deploy] Updated current symlink to $REL_DIR" >> "$LOG"
            echo "[deploy] Release $TS deployed successfully at $(date)" >> "$LOG"

            KEEP=4
            cd "$RELEASES_DIR" || exit 0
            ls -1t | tail -n +$((KEEP+1)) | while read -r rel; do
              [ -d "$rel" ] && [ "$rel" != "$TS" ] && rm -rf "$RELEASES_DIR/$rel" && echo "[deploy] Cleaned up old release: $rel" >> "$LOG"
            done
            echo "[deploy] Cleanup completed, keeping last $KEEP releases" >> "$LOG"
          '

      - name: Restart Node.js server
        run: |
          sudo apt-get install -y sshpass curl
          HOST="${{ secrets.DEPLOY_SSH_HOST }}"
          USER="${{ secrets.DEPLOY_SSH_USER }}"
          PASS="${{ secrets.DEPLOY_SSH_PASSWORD }}"
          PORT="${{ secrets.DEPLOY_SSH_PORT }}"; [ -z "$PORT" ] && PORT=22
          TOKEN="${{ secrets.RESTART_SECRET_TOKEN }}"

          echo "[restart] Killing old process..."
          curl -X POST "https://houle.ai/api/kill/" -H "Authorization: Bearer $TOKEN" -s -o /dev/null -w "[restart] Kill request status: %{http_code}\n" || echo "[restart] Kill request failed or no process to kill"

          echo "[restart] Waiting for process to terminate..."
          sleep 30

          echo "[restart] Starting new process (refreshing symlink each restart)..."
          sshpass -p "$PASS" ssh -p "$PORT" -o StrictHostKeyChecking=no "$USER@$HOST" '
            set -e
            nohup bash -lc "while true; do cd sites/houle.ai/current && node server.js >> server.out 2>&1; echo \"Node crashed, restarting...\" >> server.out; sleep 1; done" &
          ' || echo "[restart] SSH command completed"

          sleep 30

      - name: Health check and warmup
        run: |
          sudo apt-get install -y curl
          BASE_URL="https://houle.ai"
          ATTEMPTS=40; SLEEP=3; OK=0
          for i in $(seq 1 $ATTEMPTS); do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" -L "$BASE_URL/")
            if [ "$STATUS" -eq 200 ]; then
              echo "✅ Health check OK"
              OK=1
              break
            fi
            echo "Waiting for server... ($i/$ATTEMPTS, got $STATUS)"
            sleep $SLEEP
          done
          [ "$OK" -eq 1 ] || { echo "❌ Health check failed"; exit 1; }

          echo "[deploy] Warming up paths..."
          for path in "/" "/en/" "/fr/"; do
            curl -fsSL "$BASE_URL$path" >/dev/null 2>&1 || true
          done

          echo "[deploy] Simple warmup of next/image URLs (non-blocking)"
          for locale in en fr; do
            HTML=$(curl -fsSL "$BASE_URL/$locale/" || true)
            echo "$HTML" | grep -Eo '/_next/image/\?url=[^" ]+' | sed 's/&amp;/\&/g' | head -n 30 | while read -r u; do
              curl -fsSL "$BASE_URL$u" >/dev/null 2>&1 || true
            done
          done

          echo "[deploy] Deployment completed successfully"
